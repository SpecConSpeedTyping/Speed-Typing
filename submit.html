<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Submit Your Scores</title>
  <link rel="stylesheet" href="page2.css"> <!-- Link your CSS file here if needed -->
</head>
<body>
  <div class="container">
    <h1>Submit your speed typing test score</h1>
    <p><center>Please ensure your details are correct before you submit as you will not be able to change it afterwards.</center></p>
    <form id="scoreForm"
      method="POST"
      action="https://flow.zoho.com/841213870/flow/webhook/incoming?zapikey=1001.4fb15fb92985f0cfaf7cd624353c7c0e.584a09ef44b38d044501bd5bba5b0e97&isdebug=false" 
      >
      <label for="email">Email:</label>
      <input type="email" id="email" name="email" placeholder="Enter your email" required>
      <label for="applicationid">Unique ID:</label>
      <input type="text" id="applicationid" name="ApplicationID" placeholder="Enter your Unique ID" pattern="ZR_\d+_CAND" required>
      <label for="SAIDNumber">SA ID Number:</label>
      <input type="text" id="SAIDNumber" name="SAIDNumber" placeholder="Enter your valid SA ID Number" maxlength="13" pattern="\d{13}" required>
      <input type="hidden" id="wpm" name="wpm" value=""> <!-- Add hidden input for WPM -->
      <input type="hidden" id="accuracy" name="accuracy" value=""> <!-- Add hidden input for Accuracy -->
      <input type="hidden" id="mistakes" name="mistakes" value=""> <!-- Add hidden input for Mistakes -->
      <input type="hidden" id="passOrFail" name="AssociatedTag" value=""><!-- Add hidden input for pass or fail -->
      <button type="submit" id="submitButton">Submit</button>
    </form>
    <div class="score-info">
      <h2>Your Score:</h2>
      <p>WPM: <span id="wpmDisplay">0</span></p>
      <p>Accuracy: <span id="accuracyDisplay">0%</span></p>
      <p>Mistakes: <span id="mistakesDisplay">0</span></p> <!-- Display Mistakes -->
    </div>
    <div id="submissionResult"></div> <!-- Display submission result -->
  </div>

<script>
  // Disallow going back to the previous page
  history.pushState(null, null, location.href);
  window.onpopstate = function () {
    history.go(1);
  };

  document.addEventListener("DOMContentLoaded", function () {
    const wpmDisplay = document.getElementById("wpmDisplay");
    const accuracyDisplay = document.getElementById("accuracyDisplay");
    const mistakesDisplay = document.getElementById("mistakesDisplay");
    const emailInput = document.getElementById("email");
    const applicationID = document.getElementById("applicationid");
    const saidNumberInput = document.getElementById("SAIDNumber");
    const submitButton = document.getElementById("submitButton");
    const submissionResult = document.getElementById("submissionResult");

    // Retrieve saved WPM, Accuracy, Mistakes, and Email from sessionStorage
    const savedWPM = sessionStorage.getItem("WPM");
    const savedAccuracy = sessionStorage.getItem("Accuracy");
    const savedMistakes = sessionStorage.getItem("Mistakes");
    const storedEmail = sessionStorage.getItem("userEmail");

    // Debugging: Log retrieved session storage values
    console.log("Saved WPM:", savedWPM);
    console.log("Saved Accuracy:", savedAccuracy);
    console.log("Saved Mistakes:", savedMistakes);
    console.log("Stored Email:", storedEmail);

    // Update the page with the retrieved values
    if (savedWPM && savedAccuracy && savedMistakes) {
      wpmDisplay.innerText = savedWPM;
      accuracyDisplay.innerText = savedAccuracy;
      mistakesDisplay.innerText = savedMistakes;
      document.getElementById("wpm").value = savedWPM;
      document.getElementById("accuracy").value = savedAccuracy;
      document.getElementById("mistakes").value = savedMistakes;

      // Calculate and set pass/fail value
      const passOrFailValue = savedWPM >= 20 ? "Passed Speed Typing Test" : "Failed Speed Typing Test";
      document.getElementById("passOrFail").value = passOrFailValue;
    } else {
      alert("Missing session storage values. Please complete the speed typing test first.");
      window.location.href = "https://taptypingtest.netlify.app/";
      return;
    }

    // Form submission logic
    document.getElementById("scoreForm").addEventListener("submit", function (event) {
      event.preventDefault(); // Prevent default form submission

      // Validate email
      if (!validateEmail(emailInput.value)) {
        alert("Please enter a valid email address.");
        return;
      }

      // Validate SA ID Number
      if (!validateSAIDNumber(saidNumberInput.value)) {
        alert("Please enter a valid 13-digit SA ID Number.");
        return;
      }

      // Validate Application ID
      if (!validateApplicationID(applicationID.value)) {
        alert("Please enter a valid Application ID in the format 'ZR_12345_CAND'.");
        return;
      }

      // Validate stored email
      if (emailInput.value !== storedEmail) {
        alert("Emails do not match. Please enter the same email you used on the previous page.");
        return;
      }

      // Confirm submission
      if (!confirm("Are you sure you want to submit the form?")) {
        return;
      }

      // Submit the form data
      const formData = new FormData(this);
      fetch(this.action, {
        method: this.method,
        body: formData,
      })
        .then(response => response.json())
        .then(data => {
          handleFormSubmissionResult(data);
        })
        .catch(error => console.error("Error submitting form:", error));
    });

    // Email validation
    function validateEmail(email) {
      const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return regex.test(email);
    }

    // SA ID Number validation
    function validateSAIDNumber(saidNumber) {
      const regex = /^\d{13}$/;
      return regex.test(saidNumber);
    }

    // Application ID validation
    function validateApplicationID(applicationID) {
      const regex = /^ZR_\d+_CAND$/;
      return regex.test(applicationID);
    }

    // Handle form submission result
    function handleFormSubmissionResult(result) {
      if (result.result === "success") {
        submissionResult.innerHTML = '<p><center><h1>Submission Successful</h1></center></p>';
        submitButton.style.display = "none";

        // Redirect after 1.5 seconds
        setTimeout(function () {
          window.location.href = "thankyou.html";
        }, 1500);
      } else {
        submissionResult.innerText = "Your Speed Typing Test Results failed to submit.";
      }
    }
  });
</script>
</body>
</html>
